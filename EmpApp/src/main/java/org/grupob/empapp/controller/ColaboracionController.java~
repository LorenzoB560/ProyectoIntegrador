package org.grupob.empapp.controller;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;
import org.grupob.comun.dto.LoginUsuarioEmpleadoDTO;
import org.grupob.empapp.dto.EmpleadoSimpleDTO;
import org.grupob.empapp.dto.SolicitudColaboracionDTO;
import org.grupob.empapp.service.ColaboracionService; // Cambiado a interfaz
import org.grupob.empapp.service.CookieService;
import org.grupob.empapp.service.EmpleadoService; // Cambiado a interfaz
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.CookieValue;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

@Controller
@RequestMapping("/empapp/colaboraciones")
public class ColaboracionController {

    private final ColaboracionService colaboracionService;
    private final CookieService cookieService;
    // private final EmpleadoService empleadoService; // No es necesario aquí si solo cargas desde ColaboracionService

    @Autowired
    public ColaboracionController(ColaboracionService colaboracionService, CookieService cookieService) {
        this.cookieService = cookieService;
        this.colaboracionService = colaboracionService;

    }

    private UUID getEmpleadoIdActual(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            LoginUsuarioEmpleadoDTO usuarioLogeado = (LoginUsuarioEmpleadoDTO) session.getAttribute("usuarioLogeado");
            if (usuarioLogeado != null) {
                return usuarioLogeado.getId();
            }
        }
        return null;
    }

    @GetMapping("/solicitar")
    public String mostrarFormularioSolicitud(Model modelo,
                                             @CookieValue(name = "usuario", required = false) String usuariosCookie,
                                             HttpServletRequest request) {
        UUID empleadoIdActual = getEmpleadoIdActual(request);
        if (empleadoIdActual == null) {
            return "redirect:/empapp/login";
        }

        try {
            List<EmpleadoSimpleDTO> empleadosParaSolicitar = colaboracionService.getOtrosEmpleados(empleadoIdActual)
                    .stream()
                    .map(e -> new EmpleadoSimpleDTO(e.getId(), e.getNombre() + " " + e.getApellido()))
                    .collect(Collectors.toList());
            modelo.addAttribute("empleados", empleadosParaSolicitar);
        } catch (Exception e) {
            modelo.addAttribute("errorMessage", "Error al cargar empleados: " + e.getMessage());
            modelo.addAttribute("empleados", List.of()); // Lista vacía en caso de error
        }
        // No se necesita "idReceptor" si el envío lo maneja el RestController
        LoginUsuarioEmpleadoDTO dto = (LoginUsuarioEmpleadoDTO) request.getSession().getAttribute("usuarioLogeado");

        modelo.addAttribute("dto", dto);

        return "colaboraciones/enviar-solicitud";
    }

    @GetMapping("/listado")
    public String mostrarListados(Model modelo,
                                  @CookieValue(name = "usuario", required = false) String usuariosCookie,
                                  HttpServletRequest request) {
        UUID empleadoIdActual = getEmpleadoIdActual(request);
        if (empleadoIdActual == null) {
            return "redirect:/empapp/login";
        }

        try {
            List<SolicitudColaboracionDTO> recibidas = colaboracionService.getSolicitudesRecibidas(empleadoIdActual);
            List<SolicitudColaboracionDTO> enviadas = colaboracionService.getSolicitudesEnviadas(empleadoIdActual);

            modelo.addAttribute("solicitudesRecibidas", recibidas);
            modelo.addAttribute("solicitudesEnviadas", enviadas);
        } catch (Exception e) {
            modelo.addAttribute("errorMessage", "Error al cargar listados: " + e.getMessage());
            modelo.addAttribute("solicitudesRecibidas", List.of());
            modelo.addAttribute("solicitudesEnviadas", List.of());
        }

        LoginUsuarioEmpleadoDTO dto = (LoginUsuarioEmpleadoDTO) request.getSession().getAttribute("usuarioLogeado");

        modelo.addAttribute("dto", dto);
        return "colaboraciones/listado-solicitudes";
    }
    @GetMapping("/historial")
    public String mostrarPaginaHistorialColaboraciones(Model modelo,
                                                       @CookieValue(name = "usuario", required = false) String usuariosCookie,
                                                       HttpServletRequest request) {
//        logger.debug("Accediendo a mostrarPaginaHistorialColaboraciones");
        UUID empleadoIdActual = getEmpleadoIdActual(request);
        if (empleadoIdActual == null) {
//            logger.warn("Usuario no autenticado intentando acceder a /empapp/colaboraciones/historial. Redirigiendo a login.");
            return "redirect:/empapp/login"; // Redirigir si no hay usuario en sesión
        }

        // Ya no se cargan los datos aquí. Solo se sirve la plantilla.
        // El título de la página se puede manejar directamente en el HTML o pasarlo si se desea.
        // model.addAttribute("pageTitle", "Historial de Colaboraciones");
//        logger.info("Sirviendo plantilla base para historial de colaboraciones del empleado ID: {}", empleadoIdActual);
        LoginUsuarioEmpleadoDTO dto = (LoginUsuarioEmpleadoDTO) request.getSession().getAttribute("usuarioLogeado");

        modelo.addAttribute("dto", dto);
        return "colaboraciones/historial-colaboraciones"; // Ruta a tu archivo Thymeleaf
    }
}