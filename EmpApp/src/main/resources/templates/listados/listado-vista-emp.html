<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empleados</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        .loading-spinner {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .table th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }
        .employee-link {
            color: #0066cc;
            text-decoration: underline;
            cursor: pointer;
        }
        .employee-link:hover {
            color: #004080;
        }
        .status-active {
            color: green;
            font-weight: bold;
        }
        .status-inactive {
            color: red;
            font-weight: bold;
        }
        .btn-sort {
            background: none;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-sort.active {
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .especialidad-badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
            color: white;
            background-color: #6c757d;
            margin-right: 3px;
        }
    </style>
</head>
<body>
<div class="container-fluid my-4">
    <h1 class="text-center mb-4">Gestión de Empleados</h1>

    <!-- Sección de filtros -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-3 mb-2">
                <label for="filtroNombre" class="form-label">Nombre:</label>
                <input type="text" class="form-control" id="filtroNombre" placeholder="Filtrar por nombre">
            </div>
            <div class="col-md-3 mb-2">
                <label for="filtroDepartamento" class="form-label">Departamento:</label>
                <input type="text" class="form-control" id="filtroDepartamento" placeholder="Filtrar por departamento">
            </div>
            <div class="col-md-3 mb-2">
                <label for="filtroComentario" class="form-label">Comentarios:</label>
                <input type="text" class="form-control" id="filtroComentario" placeholder="Filtrar por comentarios">
            </div>
            <div class="col-md-3 mb-2">
                <label for="filtroFechaAntes" class="form-label">Contratados antes de:</label>
                <input type="date" class="form-control" id="filtroFechaAntes">
            </div>
        </div>
        <div class="row">
            <div class="col-md-3 mb-2">
                <label for="filtroSalarioMinimo" class="form-label">Salario mínimo:</label>
                <input type="number" class="form-control" id="filtroSalarioMinimo" placeholder="Ej: 30000">
            </div>
            <div class="col-md-9 d-flex align-items-end justify-content-end mb-2">
                <button id="aplicarFiltros" class="btn btn-primary me-2">Aplicar Filtros</button>
                <button id="limpiarFiltros" class="btn btn-secondary">Limpiar Filtros</button>
            </div>
        </div>
    </div>

    <!-- Botón de carga inicial -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="cargarDatos" class="btn btn-success">Cargar Empleados</button>
        <div class="d-flex align-items-center">
            <span class="me-2">Ordenar por:</span>
            <button id="ordenarPorNombre" class="btn-sort active me-2">Nombre</button>
            <button id="ordenarPorSalario" class="btn-sort me-2">Salario</button>
            <span id="direccionOrden" class="btn-sort">↑</span>
        </div>
    </div>

    <!-- Resultados y carga -->
    <div id="contadorResultados" class="mb-2 fw-bold"></div>
    <div id="cargando" class="loading-spinner" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
    <div id="error" class="alert alert-danger" style="display: none;"></div>

    <!-- Tabla de empleados -->
    <div class="table-responsive">
        <table id="tablaEmpleados" class="table table-striped table-hover" style="display: none;">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Comentarios</th>
                <th>Fecha Contratación</th>
                <th>Salario</th>
                <th>Comisión</th>
                <th>Departamento</th>
                <th>Jefe</th>
                <th>Especialidades</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody id="cuerpoTabla">
            <!-- Los datos de empleados se cargarán aquí -->
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    <div id="paginacion" class="d-flex justify-content-center mt-3">
        <!-- Controles de paginación se generarán dinámicamente -->
    </div>
</div>

<script>
    // Variables para mantener estado de la búsqueda
    let paginaActual = 0;
    let tamañoPagina = 10;
    let totalPaginas = 0;
    let totalElementos = 0;
    let ordenarPor = "nombre";
    let direccionOrden = "asc";

    // Event listeners para los botones principales
    document.getElementById('cargarDatos').addEventListener('click', () => obtenerEmpleados(0));
    document.getElementById('aplicarFiltros').addEventListener('click', () => obtenerEmpleados(0));
    document.getElementById('limpiarFiltros').addEventListener('click', limpiarFiltros);
    document.addEventListener('DOMContentLoaded', () => obtenerEmpleados(0));

    // Event listeners para ordenación
    document.getElementById('ordenarPorNombre').addEventListener('click', () => {
        ordenarPor = "nombre";
        document.getElementById('ordenarPorNombre').classList.add('active');
        document.getElementById('ordenarPorSalario').classList.remove('active');
        obtenerEmpleados(0);
    });

    document.getElementById('ordenarPorSalario').addEventListener('click', () => {
        ordenarPor = "salario";
        document.getElementById('ordenarPorSalario').classList.add('active');
        document.getElementById('ordenarPorNombre').classList.remove('active');
        obtenerEmpleados(0);
    });

    document.getElementById('direccionOrden').addEventListener('click', () => {
        if (direccionOrden === "asc") {
            direccionOrden = "desc";
            document.getElementById('direccionOrden').textContent = "↓";
        } else {
            direccionOrden = "asc";
            document.getElementById('direccionOrden').textContent = "↑";
        }
        obtenerEmpleados(0);
    });

    // Función principal para obtener empleados con filtros, paginación y ordenación
    function obtenerEmpleados(pagina) {
        const nombre = document.getElementById('filtroNombre').value.trim();
        const departamento = document.getElementById('filtroDepartamento').value.trim();
        const comentario = document.getElementById('filtroComentario').value.trim();
        const fechaLimite = document.getElementById('filtroFechaAntes').value;
        const salarioMinimo = document.getElementById('filtroSalarioMinimo').value;

        // Actualizar página actual
        paginaActual = pagina;

        // Construir URL con todos los parámetros
        let url = new URL('http://localhost:8080/empleados/listado');

        // Parámetros de filtro
        if (nombre) url.searchParams.append('nombre', nombre);
        if (departamento) url.searchParams.append('departamento', departamento);
        if (comentario) url.searchParams.append('comentario', comentario);
        if (fechaLimite) url.searchParams.append('contratadosAntesDe', fechaLimite);
        if (salarioMinimo) url.searchParams.append('salarioMinimo', salarioMinimo);

        // Parámetros de paginación y ordenación
        url.searchParams.append('page', pagina);
        url.searchParams.append('size', tamañoPagina);
        url.searchParams.append('sortBy', ordenarPor);
        url.searchParams.append('sortDir', direccionOrden);

        // Mostrar indicador de carga
        document.getElementById('cargando').style.display = 'block';
        document.getElementById('tablaEmpleados').style.display = 'none';
        document.getElementById('error').style.display = 'none';
        document.getElementById('contadorResultados').textContent = '';

        fetch(url)
            .then(respuesta => {
                if (!respuesta.ok) {
                    throw new Error('Error de red: ' + respuesta.status);
                }
                return respuesta.json();
            })
            .then(datos => {
                // Guardar información de paginación
                paginaActual = datos.number;
                totalPaginas = datos.totalPages;
                totalElementos = datos.totalElements;

                // Mostrar resultados
                llenarTabla(datos.content);
                // Crear controles de paginación
                crearControlesPaginacion();
                // Mostrar conteo de resultados
                document.getElementById('contadorResultados').textContent =
                    `Mostrando ${datos.numberOfElements} de ${totalElementos} resultados - Página ${paginaActual + 1} de ${totalPaginas || 1}`;
            })
            .catch(error => {
                mostrarError("Error al obtener datos: " + error.message);
            });
    }

    // Función para limpiar filtros
    function limpiarFiltros() {
        document.getElementById('filtroNombre').value = "";
        document.getElementById('filtroDepartamento').value = "";
        document.getElementById('filtroComentario').value = "";
        document.getElementById('filtroFechaAntes').value = "";
        document.getElementById('filtroSalarioMinimo').value = "";
        obtenerEmpleados(0); // Resetear a primera página
    }

    // Función para crear controles de paginación
    function crearControlesPaginacion() {
        const divPaginacion = document.getElementById('paginacion');
        divPaginacion.innerHTML = '';

        if (totalPaginas <= 1) return; // No mostrar paginación si hay una página o menos

        // Botón anterior
        const botonAnterior = document.createElement('button');
        botonAnterior.innerHTML = '&laquo; Anterior';
        botonAnterior.className = 'btn btn-outline-primary me-2';
        botonAnterior.disabled = paginaActual === 0;
        botonAnterior.addEventListener('click', () => obtenerEmpleados(paginaActual - 1));
        divPaginacion.appendChild(botonAnterior);

        // Botones de páginas
        const paginaInicio = Math.max(0, paginaActual - 2);
        const paginaFin = Math.min(totalPaginas - 1, paginaActual + 2);

        for (let i = paginaInicio; i <= paginaFin; i++) {
            const botonPagina = document.createElement('button');
            botonPagina.textContent = i + 1;
            botonPagina.className = i === paginaActual ? 'btn btn-primary me-2' : 'btn btn-outline-primary me-2';
            botonPagina.addEventListener('click', () => obtenerEmpleados(i));
            divPaginacion.appendChild(botonPagina);
        }

        // Botón siguiente
        const botonSiguiente = document.createElement('button');
        botonSiguiente.innerHTML = 'Siguiente &raquo;';
        botonSiguiente.className = 'btn btn-outline-primary';
        botonSiguiente.disabled = paginaActual >= totalPaginas - 1;
        botonSiguiente.addEventListener('click', () => obtenerEmpleados(paginaActual + 1));
        divPaginacion.appendChild(botonSiguiente);
    }

    // Función para llenar la tabla con los datos
    function llenarTabla(datos) {
        const cuerpoTabla = document.getElementById('cuerpoTabla');
        cuerpoTabla.innerHTML = '';

        if (datos.length === 0) {
            // Mostrar mensaje si no hay resultados
            const fila = document.createElement('tr');
            const celda = document.createElement('td');
            celda.setAttribute('colspan', '11');
            celda.textContent = 'No se encontraron empleados con esos criterios';
            celda.style.textAlign = 'center';
            celda.style.padding = '20px';
            fila.appendChild(celda);
            cuerpoTabla.appendChild(fila);
        } else {
            // Mostrar empleados
            datos.forEach(emp => {
                const fila = document.createElement('tr');

                // Crear enlace en el nombre
                const nombreConEnlace = emp.nombre ?
                    `<a href="/empleado/detalle/${emp.id}" class="employee-link">${emp.nombre}</a>` : 'N/A';

                // Mostrar jefe si existe
                const infoJefe = emp.nombreJefe ?
                    `<a href="/empleado/detalle/${emp.idJefe}" class="employee-link">${emp.nombreJefe}</a>` :
                    'N/A';

                // Mostrar especialidades
                const especialidades = formatearEspecialidades(emp.especialidades);

                fila.innerHTML = `
                        <td>${emp.id || ''}</td>
                        <td>${nombreConEnlace}</td>
                        <td>${emp.comentarios || 'N/A'}</td>
                        <td>${formatearFecha(emp.periodo?.fechaInicio)}</td>
                        <td>${formatearMoneda(emp.salario)}</td>
                        <td>${formatearMoneda(emp.comision)}</td>
                        <td>${formatearDepartamento(emp.departamento)}</td>
                        <td>${infoJefe}</td>
                        <td>${especialidades}</td>
                        <td><span class="${emp.activo ? 'status-active' : 'status-inactive'}">${emp.activo ? 'Activo' : 'Inactivo'}</span></td>
                        <td>
                            <a href="/empleado/detalle/${emp.id}" class="btn btn-sm btn-primary">Ver</a>
                        </td>
                    `;
                cuerpoTabla.appendChild(fila);
            });
        }

        document.getElementById('cargando').style.display = 'none';
        document.getElementById('tablaEmpleados').style.display = 'table';
    }

    // Función para formatear especialidades
    function formatearEspecialidades(especialidades) {
        if (!especialidades || especialidades.length === 0) return 'N/A';

        return especialidades.map(esp =>
            `<span class="especialidad-badge">${esp.nombre}</span>`
        ).join(' ');
    }

    // Funciones de formateo
    function formatearFecha(textoFecha) {
        if (!textoFecha) return 'N/A';
        const fecha = new Date(textoFecha);
        return fecha.toLocaleDateString('es-ES');
    }

    function formatearMoneda(cantidad) {
        if (cantidad === undefined || cantidad === null) return 'N/A';
        return new Intl.NumberFormat('es-ES', {
            style: 'currency',
            currency: 'EUR'
        }).format(cantidad);
    }

    function formatearDepartamento(departamento) {
        if (!departamento) return 'N/A';
        return `
                <div>
                    <a href="/departamentos/detalle/${departamento.id}" class="employee-link">${departamento.nombre || '-'}</a><br>
                    Código: ${departamento.codigo || '-'}, ${departamento.localidad || '-'}
                </div>
            `;
    }

    function mostrarError(mensaje) {
        const elementoError = document.getElementById('error');
        elementoError.textContent = mensaje;
        elementoError.style.display = 'block';
        document.getElementById('cargando').style.display = 'none';
    }
</script>
</body>
</html>
